<template>
    <div class="slds-box slds-box_x-small slds-theme_shade query-builder">
        <h3 class="slds-text-heading_small slds-m-bottom_small">
            <lightning-icon icon-name="utility:filterList" size="x-small" class="slds-m-right_x-small"></lightning-icon>
            Detection Conditions
        </h3>

        <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_small">
            Define conditions to detect matching records. Leave empty to match all records.
        </p>

        <!-- Loading State -->
        <template if:true={isLoadingFields}>
            <div class="slds-is-relative" style="height: 50px;">
                <lightning-spinner alternative-text="Loading fields..." size="small"></lightning-spinner>
            </div>
        </template>

        <template if:false={isLoadingFields}>
            <!-- Condition Builder Row -->
            <div class="slds-grid slds-gutters slds-wrap slds-m-bottom_small">
                <!-- Logic Selector (shown after first condition) -->
                <template if:true={showLogicSelector}>
                    <div class="slds-col slds-size_1-of-1 slds-small-size_1-of-6 slds-m-bottom_x-small">
                        <lightning-combobox
                            name="logic"
                            label="Logic"
                            placeholder="--"
                            options={logicOptions}
                            value={currentLogic}
                            onchange={handleLogicChange}
                            variant="label-stacked">
                        </lightning-combobox>
                    </div>
                </template>

                <!-- Field Selector (Searchable) -->
                <div class="slds-col slds-size_1-of-1 slds-small-size_1-of-4 slds-m-bottom_x-small">
                    <div class="slds-form-element">
                        <label class="slds-form-element__label" for="field-search">Field</label>
                        <div class="slds-form-element__control">
                            <div class="slds-combobox_container">
                                <div class={fieldComboboxClass} data-id="field-combobox" role="combobox" aria-expanded={isFieldDropdownOpen} aria-haspopup="listbox">
                                    <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right" role="none">
                                        <input
                                            type="text"
                                            class="slds-input slds-combobox__input"
                                            id="field-search"
                                            aria-autocomplete="list"
                                            aria-controls="field-listbox"
                                            autocomplete="off"
                                            role="textbox"
                                            placeholder="Search fields..."
                                            value={fieldSearchTerm}
                                            onfocus={handleFieldInputFocus}
                                            onblur={handleFieldInputBlur}
                                            oninput={handleFieldSearchInput}
                                            onkeydown={handleFieldKeyDown}
                                            disabled={isFieldDisabled}>
                                        <span class="slds-icon_container slds-icon-utility-search slds-input__icon slds-input__icon_right">
                                            <lightning-icon icon-name="utility:search" size="x-small" alternative-text="Search"></lightning-icon>
                                        </span>
                                    </div>
                                    <div id="field-listbox" class="slds-dropdown slds-dropdown_length-10 slds-dropdown_fluid" role="listbox" onmousedown={handleDropdownMouseDown}>
                                        <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                                            <template if:true={hasFilteredFields}>
                                                <template for:each={filteredFieldOptions} for:item="field">
                                                    <li key={field.value} role="presentation" class="slds-listbox__item">
                                                        <div
                                                            class={field.itemClass}
                                                            role="option"
                                                            data-value={field.value}
                                                            onclick={handleFieldSelect}>
                                                            <span class="slds-media__body">
                                                                <span class="slds-truncate" title={field.label}>
                                                                    {field.label}
                                                                    <span class="slds-text-body_small slds-text-color_weak slds-m-left_xx-small">({field.value})</span>
                                                                </span>
                                                            </span>
                                                        </div>
                                                    </li>
                                                </template>
                                            </template>
                                            <template if:false={hasFilteredFields}>
                                                <li role="presentation" class="slds-listbox__item">
                                                    <div class="slds-media slds-listbox__option slds-listbox__option_plain">
                                                        <span class="slds-media__body">
                                                            <span class="slds-truncate slds-text-color_weak">No matching fields</span>
                                                        </span>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Operator Selector -->
                <div class="slds-col slds-size_1-of-1 slds-small-size_1-of-4 slds-m-bottom_x-small">
                    <lightning-combobox
                        name="operator"
                        label="Operator"
                        placeholder="Select Operator"
                        options={operatorOptions}
                        value={currentOperator}
                        onchange={handleOperatorChange}
                        disabled={isOperatorDisabled}
                        variant="label-stacked">
                    </lightning-combobox>
                </div>

                <!-- Value Input (Dynamic based on field type) -->
                <div class="slds-col slds-size_1-of-1 slds-small-size_1-of-4 slds-m-bottom_x-small">
                    <!-- Text Input -->
                    <template if:true={showTextInput}>
                        <lightning-input
                            type="text"
                            label="Value"
                            placeholder="Enter value"
                            value={currentValue}
                            onchange={handleValueChange}
                            variant="label-stacked">
                        </lightning-input>
                    </template>

                    <!-- Number Input -->
                    <template if:true={showNumberInput}>
                        <lightning-input
                            type="number"
                            label="Value"
                            placeholder="Enter number"
                            value={currentValue}
                            onchange={handleValueChange}
                            variant="label-stacked">
                        </lightning-input>
                    </template>

                    <!-- Picklist Input -->
                    <template if:true={showPicklistInput}>
                        <template if:true={isLoadingPicklist}>
                            <div class="slds-form-element">
                                <label class="slds-form-element__label">Value</label>
                                <div class="slds-form-element__control">
                                    <lightning-spinner alternative-text="Loading..." size="small"></lightning-spinner>
                                </div>
                            </div>
                        </template>
                        <template if:false={isLoadingPicklist}>
                            <lightning-combobox
                                name="picklistValue"
                                label="Value"
                                placeholder="Select Value"
                                options={picklistOptions}
                                value={currentValue}
                                onchange={handleValueChange}
                                variant="label-stacked">
                            </lightning-combobox>
                        </template>
                    </template>

                    <!-- Boolean Input -->
                    <template if:true={showBooleanInput}>
                        <lightning-combobox
                            name="booleanValue"
                            label="Value"
                            placeholder="Select Value"
                            options={booleanOptions}
                            value={currentValue}
                            onchange={handleValueChange}
                            variant="label-stacked">
                        </lightning-combobox>
                    </template>

                    <!-- Date Input -->
                    <template if:true={showDateInput}>
                        <lightning-combobox
                            name="dateLiteral"
                            label="Date Value"
                            placeholder="Select Date"
                            options={dateLiteralOptions}
                            value={currentDateLiteral}
                            onchange={handleDateLiteralChange}
                            variant="label-stacked">
                        </lightning-combobox>
                    </template>

                    <!-- No Value Needed (null operators) -->
                    <template if:true={isNullOperator}>
                        <div class="slds-form-element">
                            <label class="slds-form-element__label">Value</label>
                            <div class="slds-form-element__control">
                                <span class="slds-text-body_small slds-text-color_weak">(not required)</span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Add Button -->
                <div class="slds-col slds-size_1-of-1 slds-small-size_1-of-6 slds-m-bottom_x-small slds-grid slds-grid_vertical-align-end">
                    <lightning-button
                        variant="brand"
                        label="Add"
                        icon-name="utility:add"
                        onclick={handleAddCondition}
                        disabled={isAddDisabled}>
                    </lightning-button>
                </div>
            </div>

            <!-- Date N Input (for LAST_N_DAYS, etc.) -->
            <template if:true={showDateNInput}>
                <div class="slds-grid slds-m-bottom_small">
                    <div class="slds-col slds-size_1-of-4">
                        <lightning-input
                            type="number"
                            label="Number of Days/Months"
                            placeholder="e.g., 30"
                            value={currentDateN}
                            onchange={handleDateNChange}
                            min="1"
                            variant="label-stacked">
                        </lightning-input>
                    </div>
                </div>
            </template>

            <!-- Specific Date Input -->
            <template if:true={showSpecificDateInput}>
                <div class="slds-grid slds-m-bottom_small">
                    <div class="slds-col slds-size_1-of-4">
                        <lightning-input
                            type="date"
                            label="Specific Date"
                            value={currentValue}
                            onchange={handleValueChange}
                            variant="label-stacked">
                        </lightning-input>
                    </div>
                </div>
            </template>

            <!-- Current Conditions List -->
            <template if:true={hasConditions}>
                <div class="slds-section slds-is-open slds-m-top_small">
                    <h3 class="slds-section__title slds-theme_shade">
                        <span class="slds-truncate slds-p-horizontal_small" title="Current Conditions">
                            Current Conditions ({conditions.length})
                        </span>
                    </h3>

                    <div class="slds-section__content">
                        <ul class="slds-has-dividers_around-space">
                            <template for:each={conditions} for:item="condition">
                                <li key={condition.id} class="slds-item slds-p-around_x-small condition-item">
                                    <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                                        <div class="condition-text">
                                            <template if:true={condition.logic}>
                                                <span class="slds-badge slds-badge_lightest slds-m-right_x-small">{condition.logic}</span>
                                            </template>
                                            <strong>{condition.fieldLabel}</strong>
                                            <span class="slds-m-horizontal_xx-small">{condition.operatorLabel}</span>
                                            <em>{condition.value}</em>
                                        </div>
                                        <lightning-button-icon
                                            icon-name="utility:delete"
                                            variant="bare"
                                            alternative-text="Remove"
                                            title="Remove Condition"
                                            data-id={condition.id}
                                            onclick={handleRemoveCondition}>
                                        </lightning-button-icon>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </template>

            <!-- Validation Error -->
            <template if:true={validationError}>
                <div class="slds-notify slds-notify_alert slds-alert_error slds-m-top_small" role="alert">
                    <lightning-icon icon-name="utility:error" size="x-small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
                    <span class="slds-text-body_small">{validationError}</span>
                </div>
            </template>

            <!-- Validating Spinner -->
            <template if:true={isValidating}>
                <div class="slds-m-top_small">
                    <lightning-spinner alternative-text="Validating..." size="small"></lightning-spinner>
                </div>
            </template>
        </template>
    </div>
</template>
